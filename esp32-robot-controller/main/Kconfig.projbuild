# ============================================================================
# ESP32-S3 Robot Controller — Kconfig.projbuild
#
# Single source of truth for ALL module configuration.
# Access via: idf.py menuconfig
#
# Menus:
#   1. WiFi Configuration        — from esp32-eth-example (network.c)
#   2. Ethernet Configuration    — from esp32-eth-example (network.c)
#   3. Robot Controller Configuration — motors, sensors, TCP, camera
#
# Author: Ahmed Al-Alousi
# Date: February 2026
# ============================================================================

# ============================================================================
# Network Configuration (from esp32-community-projects dual-interface)
# These menus are required by network.c
# ============================================================================

menu "WiFi Configuration"

    config WIFI_SSID
        string "WiFi SSID"
        default "myssid"
        help
            SSID (network name) to connect to.

    config WIFI_PASSWORD
        string "WiFi Password"
        default "mypassword"
        help
            WiFi password (WPA2).

endmenu

menu "Ethernet Configuration"
    config ENABLE_ETHERNET
        bool "Enable Ethernet (W5500)"
        default y
        select ETH_ENABLED
        select ETH_USE_SPI_ETHERNET
        select ETH_SPI_ETHERNET_W5500
        help
            Enable W5500 Ethernet module for wired network connectivity.
            The Waveshare ESP32-S3-ETH has an integrated W5500.

    if ENABLE_ETHERNET
        config ETH_SPI_HOST
            int "SPI Host"
            default 2
            range 0 2
            help
                SPI peripheral to use for W5500 communication.
                SPI2_HOST = 2 (recommended for ESP32-S3).

        config ETH_SPI_SCLK_GPIO
            int "SPI SCLK GPIO"
            range 0 48
            default 13
            help
                GPIO pin for SPI clock line (SCK).
                Waveshare ESP32-S3-ETH default: 13.

        config ETH_SPI_MOSI_GPIO
            int "SPI MOSI GPIO"
            range 0 48
            default 11
            help
                GPIO pin for SPI Master Out Slave In (MOSI).
                Waveshare ESP32-S3-ETH default: 11.

        config ETH_SPI_MISO_GPIO
            int "SPI MISO GPIO"
            range 0 48
            default 12
            help
                GPIO pin for SPI Master In Slave Out (MISO).
                Waveshare ESP32-S3-ETH default: 12.

        config ETH_SPI_CS_GPIO
            int "SPI CS GPIO"
            range 0 48
            default 14
            help
                GPIO pin for SPI Chip Select (CS).
                Waveshare ESP32-S3-ETH default: 14.

        config ETH_SPI_INT_GPIO
            int "Interrupt GPIO"
            range -1 48
            default 10
            help
                GPIO pin for W5500 interrupt (optional, -1 to disable).
                Waveshare ESP32-S3-ETH default: 10.

        config ETH_SPI_CLOCK_MHZ
            int "SPI Clock Speed (MHz)"
            default 20
            range 1 40
            help
                SPI clock frequency for W5500 communication.
                20MHz is recommended for stable operation.

        config ETH_PHY_RST_GPIO
            int "PHY Reset GPIO"
            range -1 48
            default 9
            help
                GPIO pin for W5500 reset (optional, -1 to disable).
                Waveshare ESP32-S3-ETH default: 9.

        config ETH_PHY_ADDR
            int "PHY Address"
            default 1
            range 0 31
            help
                W5500 PHY address (usually 1).
    endif
endmenu

# ============================================================================
# Robot Controller Configuration
# ============================================================================

menu "Robot Controller Configuration"

    # ========================================================================
    # Motor Driver Configuration
    # ========================================================================
    menu "Motor Driver Configuration"

        choice MOTOR_DRIVE_MODE
            prompt "Drive mode"
            default MOTOR_DRIVE_MODE_FOUR_WHEEL
            help
                Select how motors are driven.

            config MOTOR_DRIVE_MODE_TWO_WHEEL
                bool "Two-wheel (rear only)"
                help
                    Only rear motors are driven. Front wheels free-roll.

            config MOTOR_DRIVE_MODE_FOUR_WHEEL
                bool "Four-wheel (all driven)"
                help
                    All four motors driven independently.

            config MOTOR_DRIVE_MODE_TRACKED
                bool "Tracked / tank drive"
                help
                    Left and right motor pairs locked together.
        endchoice

        config MOTOR_WHEEL_BASE_MM
            int "Wheel base width (mm)"
            default 200
            range 50 1000
            help
                Distance between left and right wheel centres in millimetres.
                Used for skid-steer kinematic calculations.

        config MOTOR_MAX_SPEED_MMS
            int "Maximum speed (mm/s)"
            default 3000
            range 100 10000
            help
                Maximum linear speed at 100% PWM duty, in mm/s.
                Used to convert velocity commands to PWM percentages.
                Target: 2-3 m/s = 2000-3000 mm/s.

        config MOTOR_MAX_DUTY_PCT
            int "Maximum PWM duty (%)"
            default 80
            range 10 100
            help
                Limit maximum PWM duty cycle. Set below 100% to protect
                motors during development or limit top speed.

        config MOTOR_PWM_FREQ_HZ
            int "PWM frequency (Hz)"
            default 20000
            range 1000 50000
            help
                Motor PWM frequency. 20 kHz is above audible range.
                Lower frequencies (5 kHz) may cause motor whine.

        menu "Motor GPIO Pins"
            comment "Must not conflict with SPI (9-14), USB (19-20), UART (43-44)"

            config MOTOR_FL_PWM_GPIO
                int "Front-left PWM GPIO"
                default 4
                range 0 48

            config MOTOR_FL_DIR_GPIO
                int "Front-left direction GPIO"
                default 5
                range 0 48

            config MOTOR_FR_PWM_GPIO
                int "Front-right PWM GPIO"
                default 6
                range 0 48

            config MOTOR_FR_DIR_GPIO
                int "Front-right direction GPIO"
                default 7
                range 0 48

            config MOTOR_RL_PWM_GPIO
                int "Rear-left PWM GPIO"
                default 15
                range 0 48

            config MOTOR_RL_DIR_GPIO
                int "Rear-left direction GPIO"
                default 16
                range 0 48

            config MOTOR_RR_PWM_GPIO
                int "Rear-right PWM GPIO"
                default 17
                range 0 48

            config MOTOR_RR_DIR_GPIO
                int "Rear-right direction GPIO"
                default 18
                range 0 48

        endmenu  # Motor GPIO Pins

    endmenu  # Motor Driver Configuration

    # ========================================================================
    # PID Heading Correction
    # ========================================================================
    menu "PID Heading Correction"

        config PID_ENABLED
            bool "Enable PID heading correction"
            default y
            help
                Use IMU yaw rate feedback to correct heading drift
                during straight-line driving. Requires a connected IMU.

        config PID_KP
            int "Proportional gain (x100)"
            default 150
            range 0 10000
            depends on PID_ENABLED
            help
                Kp × 100 (e.g. 150 = Kp of 1.50).
                Higher values give faster correction but may oscillate.

        config PID_KI
            int "Integral gain (x100)"
            default 20
            range 0 10000
            depends on PID_ENABLED
            help
                Ki × 100 (e.g. 20 = Ki of 0.20).
                Helps eliminate steady-state error.

        config PID_KD
            int "Derivative gain (x100)"
            default 5
            range 0 10000
            depends on PID_ENABLED
            help
                Kd × 100 (e.g. 5 = Kd of 0.05).
                Dampens oscillations.

        config PID_INTEGRAL_LIMIT
            int "Integral limit"
            default 50
            range 1 1000
            depends on PID_ENABLED
            help
                Maximum value of the integral accumulator.
                Prevents windup during extended turns.

        config PID_OUTPUT_LIMIT
            int "Output limit"
            default 30
            range 1 100
            depends on PID_ENABLED
            help
                Maximum correction applied to motor speed difference.
                Units are percentage points.

    endmenu  # PID Heading Correction

    # ========================================================================
    # IMU Configuration
    # ========================================================================
    menu "IMU Configuration"

        config IMU_I2C_ADDR
            hex "IMU I2C address"
            default 0x68
            help
                7-bit I2C address of the MPU-9250/6500/6050.
                Default is 0x68 (AD0 pin low).
                Use 0x69 if AD0 is tied high.

        choice IMU_ACCEL_RANGE
            prompt "Accelerometer full-scale range"
            default IMU_ACCEL_RANGE_2G
            help
                Select accelerometer measurement range.
                Lower range = higher resolution.

            config IMU_ACCEL_RANGE_2G
                bool "±2g (highest resolution)"
                help
                    Best for detecting subtle movements.
                    Resolution: ~0.06 mg/LSB

            config IMU_ACCEL_RANGE_4G
                bool "±4g"
                help
                    Good balance of range and resolution.
                    Resolution: ~0.12 mg/LSB

            config IMU_ACCEL_RANGE_8G
                bool "±8g"
                help
                    For fast-moving robots or rough terrain.
                    Resolution: ~0.24 mg/LSB

            config IMU_ACCEL_RANGE_16G
                bool "±16g (highest range)"
                help
                    For high-acceleration or impact detection.
                    Resolution: ~0.49 mg/LSB
        endchoice

        choice IMU_GYRO_RANGE
            prompt "Gyroscope full-scale range"
            default IMU_GYRO_RANGE_250
            help
                Select gyroscope measurement range.
                Lower range = higher resolution for slow rotation.

            config IMU_GYRO_RANGE_250
                bool "±250 °/s (highest resolution)"
                help
                    Best for slow, precise rotation tracking.
                    Resolution: ~0.0076 °/s/LSB

            config IMU_GYRO_RANGE_500
                bool "±500 °/s"
                help
                    Good for moderate rotation speeds.
                    Resolution: ~0.015 °/s/LSB

            config IMU_GYRO_RANGE_1000
                bool "±1000 °/s"
                help
                    For fast-turning robots.
                    Resolution: ~0.030 °/s/LSB

            config IMU_GYRO_RANGE_2000
                bool "±2000 °/s (highest range)"
                help
                    For very fast rotation or spinning.
                    Resolution: ~0.061 °/s/LSB
        endchoice

    endmenu  # IMU Configuration

    # ========================================================================
    # I2C Bus Configuration (shared by camera SCCB, IMU, and URM09)
    # ========================================================================
    menu "I2C Bus Configuration"
        comment "Shared I2C bus for all devices (camera, IMU, URM09)"

        config SENSOR_I2C_SDA
            int "I2C SDA GPIO"
            default 48
            range 0 48
            help
                GPIO pin for I2C data line.
                Waveshare ESP32-S3-ETH: GPIO 48 (directly wired to camera connector).
                All I2C devices (camera SCCB, IMU, URM09) share this bus.

        config SENSOR_I2C_SCL
            int "I2C SCL GPIO"
            default 47
            range 0 48
            help
                GPIO pin for I2C clock line.
                Waveshare ESP32-S3-ETH: GPIO 47 (directly wired to camera connector).
                All I2C devices (camera SCCB, IMU, URM09) share this bus.

        config URM09_I2C_ADDR
            hex "URM09 I2C address"
            default 0x11
            help
                7-bit I2C address of the DFRobot URM09 ultrasonic sensor.
                Default is 0x11. Can be changed via the sensor's
                configuration register.

    endmenu  # I2C Bus Configuration

    # ========================================================================
    # Sensor Task Configuration
    # ========================================================================
    menu "Sensor Task Configuration"

        config SENSOR_TASK_STACK_SIZE
            int "Sensor task stack size (bytes)"
            default 4096
            range 2048 16384
            help
                FreeRTOS stack allocation for the sensor polling task.

        config SENSOR_TASK_PRIORITY
            int "Sensor task priority"
            default 6
            range 1 25
            help
                FreeRTOS task priority for the sensor polling task.
                Should be higher than the TCP tasks (5) to ensure
                timely IMU reads for PID correction, but lower than
                the motor control priority.

        config SENSOR_POLL_INTERVAL_MS
            int "Sensor poll interval (ms)"
            default 100
            range 10 1000
            help
                How often to read sensors. 100ms = 10 Hz.
                Lower values give faster response but more CPU load.
                Must be >= 40ms for URM09 at 500cm range.

    endmenu  # Sensor Task Configuration

    # ========================================================================
    # TCP Communication
    # ========================================================================
    menu "TCP Communication"

        config TCP_CMD_PORT
            int "Motor command server port"
            default 8080
            range 1024 65535
            help
                TCP port on which the ESP32 listens for motor commands
                from the ROS2 waveshare_driver node on the Pi.
                Protocol: JSON lines, e.g. {"cmd":"motor","linear":0.5,"angular":0.1}

        config TCP_SENSOR_PORT
            int "Sensor data client port"
            default 8081
            range 1024 65535
            help
                TCP port on the Pi to which the ESP32 sends sensor data.
                Protocol: JSON lines, e.g. {"type":"range","distance":0.35}

        config TCP_SENSOR_HOST
            string "Pi IP address (sensor data destination)"
            default "192.168.1.100"
            help
                IP address of the Raspberry Pi (or Mac running Docker)
                with the ROS2 waveshare_driver node. The ESP32 connects
                to this address on the sensor port to send IMU and range data.

                For Docker on Mac: Use your Mac's local IP address
                (run 'ipconfig getifaddr en0' to find it).

        config TCP_CAMERA_PORT
            int "Camera MJPEG stream port"
            default 8082
            range 1024 65535
            help
                HTTP port for the MJPEG camera stream served by the ESP32.
                The Pi fetches frames from http://<esp32_ip>:<port>/stream

    endmenu  # TCP Communication

    # ========================================================================
    # Camera Configuration (Waveshare ESP32-S3-ETH pinout)
    # ========================================================================
    menu "Camera Configuration"

        config CAMERA_ENABLED
            bool "Enable camera support"
            default n
            help
                Enable OV2640/OV5640 camera module for MJPEG streaming.
                Disable to save resources if no camera is connected.

        menu "Camera GPIO Pins (Waveshare ESP32-S3-ETH)"
            depends on CAMERA_ENABLED
            comment "Pinout from Waveshare ESP32-S3-ETH schematic"

            config CAM_PIN_PWDN
                int "Power down pin"
                default 8
                range -1 48
                help
                    GPIO for camera power control (drives MOSFET).
                    Waveshare ESP32-S3-ETH: GPIO 8.

            config CAM_PIN_RESET
                int "Reset pin"
                default -1
                range -1 48
                help
                    GPIO for camera reset. -1 if not connected.

            config CAM_PIN_XCLK
                int "XCLK pin"
                default 3
                range 0 48
                help
                    Waveshare ESP32-S3-ETH: GPIO 3.

            config CAM_PIN_SIOD
                int "SCCB SDA pin (camera I2C)"
                default 48
                range 0 48
                help
                    Camera SCCB data pin (I2C-like protocol).
                    Waveshare ESP32-S3-ETH: GPIO 48.
                    WARNING: Do not use for external I2C sensors!

            config CAM_PIN_SIOC
                int "SCCB SCL pin (camera I2C)"
                default 47
                range 0 48
                help
                    Camera SCCB clock pin (I2C-like protocol).
                    Waveshare ESP32-S3-ETH: GPIO 47.
                    WARNING: Do not use for external I2C sensors!

            config CAM_PIN_D7
                int "Data pin D7"
                default 18
                range 0 48

            config CAM_PIN_D6
                int "Data pin D6"
                default 15
                range 0 48

            config CAM_PIN_D5
                int "Data pin D5"
                default 38
                range 0 48

            config CAM_PIN_D4
                int "Data pin D4"
                default 40
                range 0 48

            config CAM_PIN_D3
                int "Data pin D3"
                default 42
                range 0 48

            config CAM_PIN_D2
                int "Data pin D2"
                default 46
                range 0 48

            config CAM_PIN_D1
                int "Data pin D1"
                default 45
                range 0 48

            config CAM_PIN_D0
                int "Data pin D0"
                default 41
                range 0 48

            config CAM_PIN_VSYNC
                int "VSYNC pin"
                default 1
                range 0 48

            config CAM_PIN_HREF
                int "HREF pin"
                default 2
                range 0 48

            config CAM_PIN_PCLK
                int "PCLK pin"
                default 39
                range 0 48

        endmenu  # Camera GPIO Pins

    endmenu  # Camera Configuration

endmenu  # Robot Controller Configuration
